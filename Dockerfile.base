FROM nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PYTHONIOENCODING=utf-8 \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility \
    TORCH_CUDA_ARCH_LIST="8.6" \
    PYTORCH_CUDA_ALLOC_CONF="max_split_size_mb:512" \
    UV_LINK_MODE=copy

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl wget unzip zip tar \
    build-essential cmake pkg-config gcc g++ \
    git git-lfs \
    ffmpeg libsndfile1-dev sox libsox-fmt-all libsox-dev \
    libasound2-dev portaudio19-dev \
    python3.10 python3.10-dev python3.10-venv \
    && rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1

RUN curl -fsSL https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

RUN uv venv /opt/venv --python 3.10 --seed
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="/opt/venv/bin:${PATH}"

RUN git lfs install --system

RUN uv pip install --no-cache-dir -i https://download.pytorch.org/whl/cu121 \
    torch==2.3.1 torchvision==0.18.1 torchaudio==2.3.1

RUN uv pip install --no-cache-dir \
    pip==24.0 setuptools==69.5.1 wheel==0.43.0 \
    numpy==1.24.4 scipy==1.11.4 \
    librosa==0.10.2 soundfile==0.12.1 \
    transformers==4.51.3 \
    Pillow==10.3.0 \
    tqdm==4.66.4 requests==2.31.0 pyyaml==6.0.1 \
    rich==13.7.1 \
    hyperpyyaml

RUN uv pip install --no-cache-dir openai-whisper==20231117
RUN uv pip install --no-cache-dir gradio==5.4.0

RUN uv pip install --no-cache-dir \
    huggingface-hub==0.23.0 modelscope==1.20.0

RUN mkdir -p /app/.cache /app/pretrained_models /tmp && \
    chmod 755 /app /app/.cache /app/pretrained_models

CMD ["sleep", "infinity"]

