# CosyVoice Base Image - RTX 3090 Optimized
# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€, Python í™˜ê²½, PyTorch ë“± ë³€ê²½ì´ ê±°ì˜ ì—†ëŠ” íŒ¨í‚¤ì§€ë“¤ì„ í¬í•¨í•œ ë² ì´ìŠ¤ ì´ë¯¸ì§€
FROM nvidia/cuda:12.1-cudnn8-devel-ubuntu22.04

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONIOENCODING=utf-8
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# RTX 3090 ìµœì í™” ì„¤ì •
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
ENV TORCH_CUDA_ARCH_LIST="8.6"  # RTX 3090 Ampere architecture
ENV PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# APT íŒ¨í‚¤ì§€ ë ˆí¬ì§€í† ë¦¬ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    # ì‹œìŠ¤í…œ ê¸°ë³¸ ë„êµ¬
    software-properties-common \
    ca-certificates \
    curl \
    wget \
    unzip \
    zip \
    tar \
    # ë¹Œë“œ ë„êµ¬
    build-essential \
    cmake \
    pkg-config \
    gcc \
    g++ \
    # Git ë° ë²„ì „ ê´€ë¦¬
    git \
    git-lfs \
    # ì˜¤ë””ì˜¤/ë¹„ë””ì˜¤ ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë³€ê²½ ë¹ˆë„ ë‚®ìŒ)
    ffmpeg \
    libsndfile1-dev \
    libsox-fmt-all \
    sox \
    libasound2-dev \
    portaudio19-dev \
    # Python 3.10 ë° ê°œë°œ ë„êµ¬
    python3.10 \
    python3.10-dev \
    python3.10-venv \
    python3.10-distutils \
    python3-pip \
    # ì¶”ê°€ ê°œë°œ ë„êµ¬
    htop \
    nano \
    vim \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Python 3.10ì„ ì‹œìŠ¤í…œ ê¸°ë³¸ Pythonìœ¼ë¡œ ì„¤ì •
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1 && \
    update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1

# pip, setuptools, wheel ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
RUN python -m pip install --no-cache-dir --upgrade \
    pip==24.0 \
    setuptools==69.5.1 \
    wheel==0.43.0

# Git LFS ì´ˆê¸°í™”
RUN git lfs install --system

# PyTorch ì—ì½”ì‹œìŠ¤í…œ ì„¤ì¹˜ (CUDA 12.1 í˜¸í™˜)
RUN pip install --no-cache-dir \
    torch==2.3.1 \
    torchaudio==2.3.1 \
    torchvision==0.18.1 \
    --index-url https://download.pytorch.org/whl/cu121

# í•µì‹¬ ML/Audio ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠëŠ” ê²ƒë“¤)
RUN pip install --no-cache-dir \
    # ìˆ˜ì¹˜ ê³„ì‚° ë° ê³¼í•™ ê³„ì‚°
    numpy==1.24.4 \
    scipy==1.11.4 \
    # ì˜¤ë””ì˜¤ ì²˜ë¦¬
    librosa==0.10.2 \
    soundfile==0.12.1 \
    # ë”¥ëŸ¬ë‹ ë„êµ¬
    transformers==4.51.3 \
    # ì´ë¯¸ì§€ ì²˜ë¦¬
    Pillow==10.3.0 \
    # ìœ í‹¸ë¦¬í‹°
    tqdm==4.66.4 \
    requests==2.31.0 \
    pyyaml==6.0.1 \
    # ë¡œê¹…
    rich==13.7.1

# OpenAI Whisper ì„¤ì¹˜ (STTìš©)
RUN pip install --no-cache-dir \
    openai-whisper==20231117

# CosyVoice í•µì‹¬ ì˜ì¡´ì„± ì„¤ì¹˜
RUN pip install --no-cache-dir \
    # CosyVoice íŠ¹í™” íŒ¨í‚¤ì§€ë“¤
    conformer==0.3.2 \
    HyperPyYAML==1.2.2 \
    lightning==2.2.4 \
    networkx==3.1 \
    pyworld==0.3.4 \
    tensorboard==2.14.0 \
    diffusers==0.29.0 \
    # ê¸°íƒ€ ìœ í‹¸ë¦¬í‹°
    gdown==5.1.0 \
    pyarrow==18.1.0 \
    pydantic==2.7.0 \
    wetext==0.0.4 \
    wget==3.2

# DeepSpeedëŠ” Linuxì—ì„œë§Œ ì„¤ì¹˜
RUN if [ "$(uname)" = "Linux" ]; then \
        pip install --no-cache-dir deepspeed==0.15.1; \
    fi

# Gradio ì›¹ í”„ë ˆì„ì›Œí¬ ì„¤ì¹˜
RUN pip install --no-cache-dir \
    gradio==5.4.0

# HuggingFace ë° ModelScope (ëª¨ë¸ ë‹¤ìš´ë¡œë“œìš©)
RUN pip install --no-cache-dir \
    huggingface-hub==0.23.0 \
    modelscope==1.20.0

# FastAPI (API ì„œë²„ìš©)
RUN pip install --no-cache-dir \
    fastapi==0.115.6 \
    fastapi-cli==0.0.4 \
    uvicorn==0.30.0

# ONNX Runtime ì„¤ì¹˜ (GPU ì§€ì›)
RUN pip install --no-cache-dir \
    onnx==1.16.0 \
    onnxruntime-gpu==1.18.0 \
    --extra-index-url https://aiinfra.pkgs.visualstudio.com/PublicPackages/_packaging/onnxruntime-cuda-12/pypi/simple/

# TensorRT ì§€ì› (RTX 3090 ìµœì í™”ìš©)
RUN pip install --no-cache-dir \
    tensorrt-cu12==10.0.1 \
    tensorrt-cu12-bindings==10.0.1 \
    tensorrt-cu12-libs==10.0.1

# ì¶”ê°€ ìœ í‹¸ë¦¬í‹° íŒ¨í‚¤ì§€
RUN pip install --no-cache-dir \
    # í”„ë¡œê·¸ë ˆìŠ¤ ë°”
    tqdm==4.66.4 \
    # HTTP í´ë¼ì´ì–¸íŠ¸
    httpx==0.27.0 \
    # ë³‘ë ¬ ì²˜ë¦¬
    joblib==1.4.0 \
    # ì„¤ì • ê´€ë¦¬
    omegaconf==2.3.0 \
    hydra-core==1.3.2 \
    # í…ìŠ¤íŠ¸ ì²˜ë¦¬
    inflect==7.3.1 \
    # ì‹œê°í™”
    matplotlib==3.7.5 \
    # í”„ë¡œí† ì½œ ë²„í¼
    protobuf==4.25.0 \
    # ë„¤íŠ¸ì›Œí‚¹
    grpcio==1.57.0 \
    grpcio-tools==1.57.0

# ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/.cache /app/pretrained_models /tmp

# ê¶Œí•œ ì„¤ì •
RUN chmod 755 /app && \
    chmod 755 /app/.cache && \
    chmod 755 /app/pretrained_models

# í™˜ê²½ ì •ë³´ ì¶œë ¥ ìŠ¤í¬ë¦½íŠ¸
RUN echo '#!/bin/bash\n\
echo "ğŸ³ CosyVoice Base Image Info"\n\
echo "=========================="\n\
echo "ğŸ§ OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d \")")\n\
echo "ğŸ Python: $(python --version)"\n\
echo "ğŸ”¥ PyTorch: $(python -c \"import torch; print(torch.__version__)\")"\n\
echo "ğŸ® CUDA Available: $(python -c \"import torch; print(torch.cuda.is_available())\")"\n\
if command -v nvidia-smi &> /dev/null; then\n\
    echo "ğŸ¯ GPU Info:"\n\
    nvidia-smi --query-gpu=name,memory.total --format=csv,noheader,nounits\n\
fi\n\
echo "ğŸ“¦ Installed Packages:"\n\
pip list | grep -E "(torch|gradio|whisper|transformers)"\n\
echo "=========================="\n' > /app/system_info.sh && \
chmod +x /app/system_info.sh

# í—¬ì‹œì²´í¬ìš© ë„êµ¬ ì„¤ì¹˜
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‚¬ì „ ë‹¤ìš´ë¡œë“œ
COPY <<EOF /app/download_models.sh
#!/bin/bash
set -e

echo "ğŸ”„ CosyVoice ëª¨ë¸ ì‚¬ì „ ë‹¤ìš´ë¡œë“œ ì¤‘..."
mkdir -p /app/pretrained_models

download_model() {
    local model_id="\$1"
    local local_dir="\$2"
    
    echo "ğŸ“¥ \$model_id ë‹¤ìš´ë¡œë“œ ì¤‘..."
    python -c "
from modelscope import snapshot_download
import os
try:
    snapshot_download('\$model_id', local_dir='\$local_dir')
    print('âœ… \$model_id ë‹¤ìš´ë¡œë“œ ì™„ë£Œ')
except Exception as e:
    print(f'âŒ \$model_id ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}')
    exit(1)
"
}

# í•„ìˆ˜ ëª¨ë¸ë“¤ ì‚¬ì „ ë‹¤ìš´ë¡œë“œ
download_model "iic/CosyVoice2-0.5B" "/app/pretrained_models/CosyVoice2-0.5B"
download_model "iic/CosyVoice-300M-SFT" "/app/pretrained_models/CosyVoice-300M-SFT"
download_model "iic/CosyVoice-ttsfrd" "/app/pretrained_models/CosyVoice-ttsfrd"

echo "ğŸ‰ ë² ì´ìŠ¤ ì´ë¯¸ì§€ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!"
EOF

RUN chmod +x /app/download_models.sh && /app/download_models.sh

# ë² ì´ìŠ¤ ì´ë¯¸ì§€ì„ì„ í‘œì‹œí•˜ëŠ” íŒŒì¼ ìƒì„±
RUN echo "CosyVoice Base Image v2.0-rtx3090 with preloaded models" > /app/.base_image_info

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="CosyVoice Team"
LABEL version="2.0-base-rtx3090"
LABEL description="CosyVoice Base Image with PyTorch, Audio libs, and system packages for RTX 3090"
LABEL gpu.architecture="ampere"
LABEL gpu.compute="8.6"
LABEL base.image="true"
LABEL cuda.version="12.1"
LABEL python.version="3.10"
LABEL pytorch.version="2.3.1"

# ê¸°ë³¸ ëª…ë ¹ì–´ - ì‹œìŠ¤í…œ ì •ë³´ ì¶œë ¥
CMD ["/app/system_info.sh"]